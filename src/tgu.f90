!======================================================================!
program tgu
!----------------------------------------------------------------------!
use params
use vars
!----------------------------------------------------------------------!
implicit none
!----------------------------------------------------------------------!
integer :: i
!----------------------------------------------------------------------!
! To test grow_up subroutine.
!----------------------------------------------------------------------!
! Initialise individual.
!----------------------------------------------------------------------!
! Basal radius                                                       (m)
!----------------------------------------------------------------------!
rb  = 0.001
!----------------------------------------------------------------------!
ht  = hrat * rb
dp  = drat * ht
rt  = alpha_ag * rb
rdp = alpha_bg * rb
Ma  = rho_wood * (1.0 / 3.0) * pi * ht * (rb ** 2 + rb * rt  + rt ** 2)
Mb  = rho_wood * (1.0 / 3.0) * pi * dp * (rb ** 2 + rb * rdp + rdp ** 2)
rb_hw = zero
Ahw   = pi * rb_hw ** 2
Astem = pi * rb    ** 2
Asw   = Astem - Ahw
!----------------------------------------------------------------------!
! Relationship from Pretzsch et al. (2015).
!----------------------------------------------------------------------!
CPA = exp (a_p + alpha_p * log (200.0 * rb))
!----------------------------------------------------------------------!
Mfol = lasa * Asw / sla
An_base = zero
PLC = 0.0
Mfro = frasa * Asw / sfra
Mtot = Mfol + Ma + Mb + Mfro
rt_hw = alpha_ag * rb_hw
Ma_hw = rho_wood * (1.0 / 3.0) * pi * ht * &
        (rb_hw ** 2 + rb_hw * rt_hw + rt_hw ** 2)
Ma_sw = Ma - Ma_hw
rdp_hw = alpha_bg * rb_hw
Mb_hw = rho_wood * (1.0 / 3.0) * pi * dp * &
        (rb_hw ** 2 + rb_hw * rdp_hw + rdp_hw ** 2)
Mb_sw = Mb - Mb_hw
Mtot_nhw = Mfol + Ma_sw + Mb_sw + Mfro
Su = KSu * Mtot_nhw
St = KSt * Mtot_nhw
hbc = zero
fd = zero
write (*,*) 'LAI = ', sla * Mfol / CPA
!----------------------------------------------------------------------!
! Water and temperature growth modifiers                      (fraction)
!----------------------------------------------------------------------!
fW_gr = 1.0
fT_gr = 1.0
!----------------------------------------------------------------------!
! Sucrose concentration                                  (g[Su] d[DM]-1)
!----------------------------------------------------------------------!
Sc = Su / (Mtot_nhw + eps)
!----------------------------------------------------------------------!
! Sucrose growth modifer                                      (fraction)
!----------------------------------------------------------------------!
fa_Su = Sc ** n_Hill / (KSu ** n_Hill + Sc ** n_Hill)
!----------------------------------------------------------------------!
do kyr = 1, nyr
  rb0 = rb
  do it = 1, ntimes
    !------------------------------------------------------------------!
    CPA = exp (a_p + alpha_p * log (200.0 * rb))
    !------------------------------------------------------------------!
    ! Gross photosynthesis                    (mol[CO2] m[ground]-2 s-1)
    !------------------------------------------------------------------!
    Ag_crown_mol = 5.0e-6
    !------------------------------------------------------------------!
    ! Crown respiration                       (mol[CO2] m[ground]-2 s-1)
    !------------------------------------------------------------------!
    R_crown_mol = 1.0e-6
    !------------------------------------------------------------------!
    ! Gross photosynthesis                       (kg[C] m[ground]-2 s-1)
    !------------------------------------------------------------------!
    Ag_crown_C = 1.0e-3 * MC * Ag_crown_mol
    !------------------------------------------------------------------!
    ! Crown respiration                          (kg[C] m[ground]-2 s-1)
    !------------------------------------------------------------------!
    R_crown_C = 1.0e-3 * MC * R_crown_mol
    !------------------------------------------------------------------!
    ! Sucrose as fraction of non-heartwood biomass            (fraction)
    !------------------------------------------------------------------!
    Ma_hw = rho_wood * (pi / 3.0) * ht * (rb_hw ** 2) * Chia
    Mb_hw = rho_wood * (pi / 3.0) * dp * (rb_hw ** 2) * Chib
    Ma_sw = Ma - Ma_hw
    Mb_sw = Mb - Mb_hw
    Mtot_nhw = Mfol + Ma_sw + Mb_sw + Mfro
    fSu = Su / (Mtot_nhw + eps)
    !------------------------------------------------------------------!
    ! Gross C uptake                                   (kg[C] ind-1 s-1)
    !------------------------------------------------------------------!
    Cup = CPA * Ag_crown_C
    !------------------------------------------------------------------!
    ! Foliage respiration                              (kg[C] ind-1 s-1)
    !------------------------------------------------------------------!
    Rfol = CPA * R_crown_C
    !------------------------------------------------------------------!
    call grow_up
    !------------------------------------------------------------------!
  end do ! it
  write (*,'(i5,7f12.4)') kyr, rb, 1.0e3*(rb-rb0), ht, dp, sla * Mfol / CPA, sfra * Mfro / CPA, Su / Mtot
  !write (*,*) Ma,rho_wood*(pi/3.0)*ht*(rb**2)*Chia, 1.0e3*(rb-rb0)
  !write (*,*) Mb,rho_wood*(pi/3.0)*dp*(rb**2)*Chib,ht,dp
end do ! kyr
!----------------------------------------------------------------------!
end program tgu
!======================================================================!
